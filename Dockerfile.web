# Build stage
FROM oven/bun:1-alpine AS builder

WORKDIR /app

# Copy workspace configuration
COPY package.json bun.lock turbo.json ./

# Copy all package manifests
COPY packages/config/package.json packages/config/
COPY packages/db/package.json packages/db/
COPY packages/irc-client/package.json packages/irc-client/
COPY apps/server-orpc/package.json apps/server-orpc/
COPY apps/web/package.json apps/web/
COPY apps/cli/package.json apps/cli/

# Install dependencies
RUN bun install --ignore-scripts

# Copy source code
COPY packages/ packages/
COPY apps/ apps/

# Build argument for server URL (set at build time)
ARG VITE_SERVER_URL=http://localhost:3001

# Build web app
WORKDIR /app/apps/web
RUN VITE_SERVER_URL=${VITE_SERVER_URL} bun run build

# Production stage
FROM nginx:alpine

# Copy built assets
COPY --from=builder /app/apps/web/dist /usr/share/nginx/html

# Copy nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
